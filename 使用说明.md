# BSC 区块链扫描项目使用说明

## 项目简介
这是一个 BSC（Binance Smart Chain）区块链数据扫描和分析项目，主要功能：
1. 构建用户地址的 Bloom Filter 过滤器
2. 扫描 BSC 链上的 Token 转账事件
3. 过滤目标用户的交易数据
4. 计算交易的 USD 价值并导出结果

## 环境要求
- Node.js 18+ 
- pnpm 包管理器
- BSC 节点 RPC 接口（可使用公共节点或本地节点）

## 安装依赖
```bash
pnpm install
```

## 使用步骤

### 第一步：准备数据文件
确保以下文件存在：

1. **`token_withbalance.csv`** - Token 基础数据文件
   - 格式：`token_address,name,symbol,usd_price,decimals`
   - 包含要扫描的 Token 合约地址和价格信息

2. **`final-results/` 目录** - 用户地址数据
   - 包含 26 个分片文件：`merged_cleaned_part{1-26}_of_26.csv`
   - 每个文件包含用户地址和相关标签信息

### 第二步：构建 Bloom Filter
```bash
node build_bloom.mjs
```

**功能**：
- 读取 `final-results/` 目录下的所有用户地址
- 构建 Bloom Filter 过滤器（预估1000万地址，0.1%假阳率）
- 生成 `userlist.bloom.json` 文件

**输出**：
```
[bloom] files=26, target n=10000000, fp=0.001
[bloom] ingest merged_cleaned_part1_of_26.csv
[bloom] ingest merged_cleaned_part2_of_26.csv
...
[bloom] saved userlist.bloom.json (m=47925292 bits, k=10)
```

### 第三步：扫描区块链数据
```bash
# 🚀 一键全链扫描（推荐）
# 自动从0区块扫描到最新区块，然后持续追踪新区块
RPC_HTTP=https://bsc-rpc.publicnode.com node scan_bloom.mjs

# 📋 自定义扫描范围
# 扫描指定区块范围
START_BLOCK=0 TARGET_END=62530000 RPC_HTTP=https://bsc-rpc.publicnode.com node scan_bloom.mjs

# 扫描到指定区块后停止（不追踪新区块）
START_BLOCK=0 TARGET_END=62530000 FOLLOW_LATEST=0 RPC_HTTP=https://bsc-rpc.publicnode.com node scan_bloom.mjs

# 完整参数示例
START_BLOCK=0 \
TARGET_END=latest \
BLOCK_STEP=5000 \
ADDRESS_CHUNK=1 \
USD_THRESHOLD=100 \
FOLLOW_LATEST=1 \
POLL_INTERVAL_MS=15000 \
RPC_HTTP=https://bsc-rpc.publicnode.com \
node scan_bloom.mjs
```

## 环境变量配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `RPC_HTTP` | `http://127.0.0.1:8545` | BSC 节点 RPC 地址 |
| `START_BLOCK` | `0` | 扫描起始区块号 |
| `TARGET_END` | `latest` | 目标终点区块号或"latest" |
| `FOLLOW_LATEST` | `1` | 扫描完成后是否持续追踪新区块 |
| `POLL_INTERVAL_MS` | `15000` | 追块模式下的轮询间隔（毫秒） |
| `BLOCK_STEP` | `5000` | 每次查询的区块范围 |
| `ADDRESS_CHUNK` | `10` | 每次查询的地址数量 |
| `CONFIRMATIONS` | `40` | 确认区块数 |
| `USD_THRESHOLD` | `100` | USD 价值过滤阈值 |
| `ROW_LIMIT` | `5000000` | 每个输出文件的行数限制 |
| `TOKENS_CSV` | `./token_withbalance.csv` | Token 数据文件路径 |
| `BLOOM_JSON` | `./userlist.bloom.json` | Bloom Filter 文件路径 |
| `PROGRESS_FILE` | `./scan_progress.json` | 断点续传进度文件路径 |
| `CHECKPOINT_INTERVAL` | `100` | 每多少个批次保存一次进度 |
| `MAX_RETRIES` | `5` | 最大重试次数 |
| `RETRY_DELAY_BASE` | `1000` | 重试延迟基数（毫秒） |

## 推荐的公共 RPC 节点

### BSC 主网
```bash
# Binance 官方节点
RPC_HTTP=https://bsc-dataseed.binance.org

# 备用节点
RPC_HTTP=https://bsc-dataseed1.defibit.io
RPC_HTTP=https://bsc-dataseed1.ninicoin.io
RPC_HTTP=https://bsc.rpc.blxrbdn.com
```

## 输出结果

### 1. Bloom Filter 文件
- **文件名**：`userlist.bloom.json`
- **内容**：序列化的 Bloom Filter 数据
- **用途**：快速判断地址是否为目标用户

### 2. 扫描结果文件
- **目录**：`./output/`
- **文件名**：`edge_events_part1.csv`, `edge_events_part2.csv`, ...
- **格式**：每个文件最多 500万行记录

**CSV 字段说明**：
```csv
tx_hash,log_index,block_number,timestamp,token_address,raw_amount,usd_value,from,to
```

- `tx_hash`: 交易哈希
- `log_index`: 日志索引
- `block_number`: 区块号
- `timestamp`: 区块时间戳
- `token_address`: Token 合约地址
- `raw_amount`: 原始转账数量（最小单位）
- `usd_value`: USD 价值
- `from`: 发送方地址
- `to`: 接收方地址

## 性能优化建议

### 1. RPC 节点选择
- **本地节点**：最快，但需要同步整个区块链
- **付费节点**：稳定快速，如 Infura、Alchemy、QuickNode
- **公共节点**：免费但可能有速率限制

### 2. 参数调优
```bash
# 高性能配置（付费节点）
BLOCK_STEP=5000
ADDRESS_CHUNK=200

# 保守配置（公共节点）
BLOCK_STEP=1000
ADDRESS_CHUNK=50
```

### 3. 分段扫描
对于大范围扫描，建议分段执行：
```bash
# 第一段：0-1000000
START_BLOCK=0 END_BLOCK=1000000 node scan_bloom.mjs

# 第二段：1000001-2000000  
START_BLOCK=1000001 END_BLOCK=2000000 node scan_bloom.mjs
```

## 故障排除

### 常见错误

1. **RPC 连接失败**
   ```
   错误：connect ECONNREFUSED
   解决：检查 RPC_HTTP 地址是否正确
   ```

2. **速率限制**
   ```
   错误：429 Too Many Requests
   解决：降低 BLOCK_STEP 和 ADDRESS_CHUNK 参数
   ```

3. **内存不足**
   ```
   错误：JavaScript heap out of memory
   解决：降低 ROW_LIMIT 参数，增加 Node.js 内存限制
   ```

### 监控日志
程序运行时会输出详细日志：
```
[scan] head=34567890 range=[0,500000] step=2000 tokens=725
[scan] window 0-1999 done
[scan] window 2000-3999 done
...
[done] wrote parts up to: edge_events_part3.csv
```

## 数据分析

扫描完成后，可以使用 SQL 或 Python 分析输出的 CSV 文件：

```sql
-- 统计每个 Token 的交易量
SELECT token_address, COUNT(*) as tx_count, SUM(usd_value) as total_usd
FROM edge_events 
GROUP BY token_address 
ORDER BY total_usd DESC;

-- 统计活跃用户
SELECT COUNT(DISTINCT from_addr) + COUNT(DISTINCT to_addr) as active_users
FROM edge_events;
```

## 新增功能

### 🔄 断点续传
系统会自动保存扫描进度到 `scan_progress.json` 文件：
- **自动恢复**：程序异常退出后重新运行，会自动从上次中断的位置继续
- **进度文件**：包含当前窗口、批次、输出文件信息等
- **参数验证**：只有在相同的 START_BLOCK 和 END_BLOCK 参数下才会恢复进度

### 🔁 增强重试机制
- **指数退避**：重试延迟逐渐增加（1s, 2s, 4s, 8s, 16s）
- **随机抖动**：避免多个实例同时重试造成拥堵
- **智能延迟**：根据错误类型调整等待时间
  - 速率限制：等待时间 × 2
  - 连接错误：等待时间 × 1.5
  - 超时错误：标准等待时间

### 🌊 流式处理
- **内存优化**：Token 数据流式加载，避免一次性读取大文件
- **流式写入**：CSV 数据流式写入，减少内存占用
- **追加模式**：断点续传时以追加模式打开现有文件

### 🛡️ 健壮性增强
- **健康检查**：启动时检查 RPC 节点连接状态
- **优雅退出**：Ctrl+C 时保存进度后退出
- **内存监控**：每5分钟输出内存使用情况
- **错误恢复**：批次失败时保存进度，便于重新运行

### 📊 增强的进度显示
```
[初始化] 正在加载Token数据...
[数据] 已加载 723 个Token信息
[初始化] 正在进行健康检查...
[进度恢复] 从窗口 150/500 继续
[恢复] 继续写入文件 ./output/edge_events_part2.csv, 当前行数: 1500000
[进度] 窗口 150/500 - 区块 298000-299999
  [批次] 1/723 - 查询 1 个Token地址
    [结果] 原始日志: 45, Bloom命中: 12, USD过滤后: 8, 有效记录: 8
[进度保存] 窗口 150/500, 批次 100
[内存] RSS: 245.67MB, Heap: 123.45/180.23MB, External: 45.67MB
```

## 使用示例

### 基本扫描
```bash
# 从区块 62530000 开始扫描 1000 个区块
START_BLOCK=62530000 END_BLOCK=62531000 ADDRESS_CHUNK=1 node scan_bloom.mjs
```

### 断点续传
```bash
# 程序异常退出后，使用相同参数重新运行即可续传
START_BLOCK=62530000 END_BLOCK=62531000 ADDRESS_CHUNK=1 node scan_bloom.mjs
```

### 优雅停止
```bash
# 运行过程中按 Ctrl+C，程序会保存进度后退出
# 再次运行时会自动从断点继续
```

### 自定义重试参数
```bash
# 设置更激进的重试策略
MAX_RETRIES=10 RETRY_DELAY_BASE=500 CHECKPOINT_INTERVAL=50 node scan_bloom.mjs
```

## 注意事项

1. **数据完整性**：确保 Bloom Filter 包含所有目标用户地址
2. **网络稳定性**：长时间扫描建议使用稳定的网络环境
3. **存储空间**：大范围扫描可能产生 GB 级别的数据文件
4. **进度文件**：不要手动删除 `scan_progress.json`，除非确定要重新开始
5. **参数一致性**：断点续传时必须使用相同的 START_BLOCK 和 END_BLOCK
6. **内存管理**：系统会自动监控内存使用，必要时可调整 ROW_LIMIT 参数
7. **合规性**：遵守相关法律法规，合理使用区块链数据

## 🚀 一键启动脚本

为了简化使用，我们提供了预配置的启动脚本：

### Windows 用户
```batch
# 双击运行 start_scan.bat 或在命令行中执行
start_scan.bat
```

### Linux/Mac 用户
```bash
# 给脚本执行权限（首次使用）
chmod +x start_scan.sh

# 运行脚本
./start_scan.sh
```

### 脚本功能
- ✅ **自动配置**：使用最佳默认参数
- ✅ **全链扫描**：从0区块扫描到最新区块
- ✅ **持续追踪**：扫描完成后持续监控新区块
- ✅ **断点续传**：支持中断后继续执行
- ✅ **进度显示**：详细的扫描进度和统计信息

## 🔧 高级用法

### 自定义扫描范围
```bash
# 扫描特定区块范围
START_BLOCK=60000000 TARGET_END=62000000 FOLLOW_LATEST=0 node scan_bloom.mjs

# 从特定区块开始，扫描到最新并持续追踪
START_BLOCK=62000000 node scan_bloom.mjs
```

### 性能调优
```bash
# 高性能配置（适合付费 RPC 节点）
BLOCK_STEP=10000 ADDRESS_CHUNK=50 node scan_bloom.mjs

# 公共节点友好配置
BLOCK_STEP=2000 ADDRESS_CHUNK=1 node scan_bloom.mjs
```

### 追块模式配置
```bash
# 快速追块（每5秒检查一次新区块）
POLL_INTERVAL_MS=5000 node scan_bloom.mjs

# 慢速追块（每1分钟检查一次新区块）
POLL_INTERVAL_MS=60000 node scan_bloom.mjs
```

## 技术支持

如遇到问题，请检查：
1. Node.js 版本是否符合要求
2. 网络连接是否正常
3. 数据文件格式是否正确
4. 环境变量设置是否正确
